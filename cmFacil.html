<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crucigrama Matem√°tico: F√°cil</title>
    <link rel="stylesheet" href="crucigrama7.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* Estilo para el timer */
        #timer-container {
            text-align: center;
            color: white;
            font-size: 1.5rem;
            font-family: 'Arial', sans-serif;
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2 class="titulo">Crucigrama Matem√°tico: F√°cil</h2>
    
    <div id="timer-container"><i class="fas fa-clock"></i> <span id="timerDisplay">00:00</span></div>

    <div class="contenido-juego">
        <section class="tablero-wrap">
            <table class="tablero" aria-label="Crucigrama 10 por 10">
                <tbody>
                    <tr>
                        <td class="casilla1"><input type="text" class="casilla bloqueada" maxlength="1" id="f0c0"></td>
                        <td class="casilla2"><input type="text" class="casilla bloqueada" maxlength="1" id="f0c1"></td>
                        <td><input type="text" class="casilla activa" maxlength="2" id="f0c2"></td>
                        <td class="casilla3"><input type="text" class="casilla bloqueada" maxlength="1" id="f0c3"></td>
                        <td class="casilla4"><input type="text" class="casilla bloqueada" maxlength="1" id="f0c4"></td>
                    </tr>
                    <tr>
                        <td class="casilla2"><input type="text" class="casilla bloqueada" maxlength="1" id="f1c0"></td>
                        <td><input type="text" class="casilla bloqueada_negra" maxlength="1" id="f1c1"></td>
                        <td class="casilla5"><input type="text" class="casilla bloqueada" maxlength="1" id="f1c2"></td>
                        <td><input type="text" class="casilla bloqueada_negra" maxlength="1" id="f1c3"></td>
                        <td class="casilla2"><input type="text" class="casilla bloqueada" maxlength="1" id="f1c4"></td>
                    </tr>
                    <tr>
                        <td><input type="text" class="casilla activa" maxlength="2" id="f2c0"></td>
                        <td class="casilla5"><input type="text" class="casilla bloqueada" maxlength="1" id="f2c1"></td>
                        <td class="casilla6"><input type="text" class="casilla bloqueada" maxlength="1" id="f2c2"></td>
                        <td class="casilla3"><input type="text" class="casilla bloqueada" maxlength="1" id="f2c3"></td>
                        <td class="casilla7"><input type="text" class="casilla bloqueada" maxlength="1" id="f2c4"></td>
                    </tr>
                    <tr>
                        <td class="casilla3"><input type="text" class="casilla bloqueada" maxlength="1" id="f3c0"></td>
                        <td><input type="text" class="casilla bloqueada_negra" maxlength="1" id="f3c1"></td>
                        <td class="casilla3"><input type="text" class="casilla bloqueada" maxlength="1" id="f3c2"></td>
                        <td><input type="text" class="casilla bloqueada_negra" maxlength="1" id="f3c3"></td>
                        <td class="casilla3"><input type="text" class="casilla bloqueada" maxlength="1" id="f3c4"></td>
                    </tr>
                    <tr>
                        <td class="casilla8"><input type="text" class="casilla bloqueada" maxlength="1" id="f4c0"></td>
                        <td class="casilla2"><input type="text" class="casilla bloqueada" maxlength="1" id="f4c1"></td>
                        <td><input type="text" class="casilla activa" maxlength="2" id="f4c2"></td>
                        <td class="casilla3"><input type="text" class="casilla bloqueada" maxlength="1" id="f4c3"></td>
                        <td><input type="text" class="casilla activa" maxlength="2" id="f4c4"></td>
                    </tr>
                </tbody>
            </table>
            <div class="acciones">
                <button type="button" id="btnVerificar" class="btn" disabled>Verificar</button>
                <button type="button" id="btnPista" class="btn btn-pista">
                    <i class="fas fa-lightbulb"></i> Pista <span id="contadorPista">(+30s)</span>
                </button>
                <div id="mensaje" class="mensaje"></div>
            </div>
            <span class="btn-volver" id="btnVolver"></span>

        </section>
        <div id="modalResultado" class="modal ocultar">
            <div class="modal-contenido">
                <span id="cerrarModal" class="cerrar">&times;</span>
                <h2 id="tituloModal"><i class="fas fa-exclamation-circle"></i> Resultado</h2>
                <p id="mensajeModal">Mensaje aqu√≠</p>
                <div id="accionesModal"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Importamos Firebase (requiere el tipo="module")
        import { db, collection, addDoc } from './firebase.js';

        // --- Variables de Estado y Timer ---
        let segundos = 0;
        let timerInterval;
        const nombreNivel = "Matem√°tico: F√°cil"; 
        
        function actualizarReloj() {
            const m = Math.floor(segundos / 60).toString().padStart(2, '0');
            const s = (segundos % 60).toString().padStart(2, '0');
            document.getElementById('timerDisplay').textContent = `${m}:${s}`;
        }
        
        // Diccionario de respuestas correctas (usando tus IDs)
        const respuestas = {
            "f0c2": "5",
            "f2c0": "7",
            "f4c2": "2",
            "f4c4": "10"
        };
        
        // --- FUNCI√ìN GUARDAR RANKING EN FIREBASE ---
        async function guardarPuntuacion(nivelNombre, tiempoTexto, nombreJugador) {
            try {
                await addDoc(collection(db, "ranking"), {
                    nivel: nivelNombre,
                    tiempo: tiempoTexto,
                    nombre: nombreJugador,
                    fecha: new Date().toLocaleDateString(),
                    timestamp: Date.now()
                });
                console.log("¬°R√©cord guardado con √©xito!");
            } catch (e) {
                console.error("Error al subir r√©cord: ", e);
                // Si falla, solo alertamos pero no rompemos el flujo
                alert("Error de conexi√≥n. No se pudo guardar el ranking.");
            }
        }
        
        // --- TUS FUNCIONES DE JUEGO ORIGINALES (Modificadas m√≠nimamente) ---
        
        // Habilita/Deshabilita bot√≥n verificar
        function revisarCampos() {
            const activos = document.querySelectorAll('.casilla.activa');
            const todosLlenos = Array.from(activos).every(input => input.value.trim() !== "");
            document.getElementById('btnVerificar').disabled = !todosLlenos;
        }

        // Verifica una palabra/n√∫mero y a√±ade clase 'error'
        function verificarPalabra(ids, palabraEsperada) {
            ids.forEach(id => document.getElementById(id).classList.remove('error'));
            const valores = ids.map(id => document.getElementById(id).value).join('').toLowerCase();
            const objetivo = palabraEsperada.toLowerCase();
            if (valores === objetivo) {
                return true;
            } else {
                ids.forEach((id, i) => {
                    const charEsperado = objetivo[i] || '';
                    const charEntrada = (document.getElementById(id).value || '').toLowerCase();
                    if (charEntrada !== charEsperado) {
                        document.getElementById(id).classList.add('error');
                    }
                });
                return false;
            }
        }

        // --- INICIALIZACI√ìN Y EVENTOS ---
        document.addEventListener('DOMContentLoaded', function () {
            // Iniciar Timer
            timerInterval = setInterval(() => {
                segundos++;
                actualizarReloj();
            }, 1000);

            // 1. Manejo de Input y Navegaci√≥n (Tu l√≥gica original)
            document.querySelectorAll('.casilla.activa').forEach(input => {
                input.addEventListener('input', () => {
                    input.value = input.value.replace(/[^0-9]/g, '').toUpperCase();
                    revisarCampos();
                });
                
                input.addEventListener('keydown', (e) => {
                    const id = input.id;
                    const match = id.match(/f(\d+)c(\d+)/);
                    if (!match) return;

                    let fila = parseInt(match[1]);
                    let col = parseInt(match[2]);

                    function mover(fila, col, direccion) {
                        let nextId = `f${fila}c${col}`;
                        let nextInput = document.getElementById(nextId);
            
                        while (nextInput && !nextInput.classList.contains("activa")) {
                            if (direccion === "up") fila--;
                            if (direccion === "down") fila++;
                            if (direccion === "left") col--;
                            if (direccion === "right") col++;
                            nextId = `f${fila}c${col}`;
                            nextInput = document.getElementById(nextId);
                        }

                        if (nextInput && nextInput.classList.contains("activa")) {
                            e.preventDefault();
                            nextInput.focus();
                        }
                    }
                    switch (e.key) {
                        case "ArrowUp": mover(fila - 1, col, "up"); break;
                        case "ArrowDown": mover(fila + 1, col, "down"); break;
                        case "ArrowLeft": mover(fila, col - 1, "left"); break;
                        case "ArrowRight": mover(fila, col + 1, "right"); break;
                    }
                });
            });

            // 2. Bot√≥n Volver
            document.getElementById('btnVolver').addEventListener('click', function() {
                window.location.href = 'categoria.html';
            });
            
            // 3. Bot√≥n Verificar
            document.getElementById('btnVerificar').addEventListener('click', () => {
                const palabraA = verificarPalabra(["f0c2"], "5");
                const palabraB = verificarPalabra(["f2c0"], "7");
                const palabraC = verificarPalabra(["f4c2"], "2"); 
                const palabraD = verificarPalabra(["f4c4"],"10");
                
                if (palabraA && palabraB && palabraC && palabraD) {
                    mostrarModal(true);
                } else {
                    mostrarModal(false);
                }
            });
            
            // 4. Bot√≥n Pista (Nuevo sistema)
            document.getElementById('btnPista').addEventListener('click', () => {
                const pendientes = Object.entries(respuestas).filter(([id, valor]) => {
                    const input = document.getElementById(id);
                    return input && input.classList.contains('activa') && input.value !== valor;
                });

                if (pendientes.length > 0) {
                    const [id, valor] = pendientes[Math.floor(Math.random() * pendientes.length)];
                    const input = document.getElementById(id);
                    input.value = valor.toUpperCase();
                    input.classList.add('pista-bloqueada');
                    input.setAttribute('readonly', true);
                    
                    // PENALIZACI√ìN: SUMAR TIEMPO
                    segundos += 30;
                    actualizarReloj();
                    
                    const timerDisplay = document.getElementById('timerDisplay');
                    timerDisplay.style.color = "red";
                    setTimeout(() => timerDisplay.style.color = "white", 500);

                    revisarCampos();
                } else {
                    alert("¬°Todo el tablero est√° correcto o lleno!");
                }
            });
            
            // 5. Cerrar Modal
            document.getElementById('cerrarModal').addEventListener('click', () => {
                document.getElementById('modalResultado').classList.add('ocultar');
            });

        }); // Fin DOMContentLoaded

        // --- FUNCI√ìN MOSTRAR MODAL (Integrado con Timer/Ranking) ---
        function mostrarModal(correcto) {
            const modal = document.getElementById('modalResultado');
            const titulo = document.getElementById('tituloModal');
            const mensaje = document.getElementById('mensajeModal');
            const acciones = document.getElementById('accionesModal');
            
            modal.classList.remove('ocultar');
            
            if (correcto) {
                clearInterval(timerInterval); // Detener reloj
                const tiempoFinal = document.getElementById('timerDisplay').textContent;
                
                titulo.innerHTML = '<i class="fas fa-star"></i> ¬°FELICIDADES!';
                mensaje.innerHTML = `¬°Lo has logrado! Tiempo: <strong>${tiempoFinal}</strong>`;
                
                // Pedir nombre para Firebase
                setTimeout(() => {
                    let nombre = prompt("üèÜ ¬°Nuevo R√©cord! \nIngresa tu nombre para el Ranking:", "An√≥nimo");
                    if (!nombre || nombre.trim() === "") nombre = "An√≥nimo";
                    
                    guardarPuntuacion(nombreNivel, tiempoFinal, nombre);
                }, 100);

                // Botones del Modal (Incluyendo Ranking)
                acciones.innerHTML = `
                    <button class="btn-modal" onclick="window.location.href='ranking.html'">
                        <i class="fas fa-trophy"></i> Ver Ranking
                    </button>
                    <button class="btn-modal" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Volver a resolver
                    </button>
                    <button class="btn-modal" onclick="window.location.href='categoria.html'">
                        <i class="fas fa-home"></i> Men√∫ principal
                    </button>
                    <button class="btn-modal" onclick="window.location.href='cmMedio.html'">
                        <i class="fas fa-forward"></i> Siguiente juego
                    </button>
                `;
            } else {
                titulo.innerHTML = '<i class="fas fa-exclamation-circle"></i> Incorrecto';
                mensaje.textContent = 'Algunas palabras est√°n mal. Intenta de nuevo.';
                acciones.innerHTML = `
                    <button class="btn-modal" id="btnSeguir">
                        <i class="fas fa-check"></i> OK
                    </button>
                `;
                document.getElementById('btnSeguir').addEventListener('click', () => {
                    modal.classList.add('ocultar');
                });
            }
        }
    </script>
</body>
</html>